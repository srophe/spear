<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
  xmlns:srophe="https://srophe.app">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

  <title>SPEAR: Syriac Persons Events and Relations</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta data-template="config:app-meta" />

  <link rel="shortcut icon" href="/favicon.ico" />

  <!-- Bootstrap 5 -->

  <!-- <link rel="stylesheet" type="text/css" href="/resources/bootstrap/css/bootstrap.min.css" /> -->
  <link rel="stylesheet" type="text/css" href="/resources/bootstrap-5.3.6/css/bootstrap.min.css" />

  <link rel="stylesheet" type="text/css" href="/resources/css/sm-core-css.css" />

  <!-- Srophe styles -->

  <link rel="stylesheet" type="text/css" href="/resources/css/syr-icon-fonts.css" />

  <link rel="stylesheet" type="text/css" href="/resources/css/style.css" />

  <link rel="stylesheet" type="text/css" media="print" href="/resources/css/print.css" />

  <!-- Leaflet -->
<!-- 
  <link rel="stylesheet" href="/resources/leaflet/leaflet.css" />

  <link rel="stylesheet" href="/resources/leaflet/leaflet.awesome-markers.css" /> -->

  <!-- JQuery -->

  <link href="/resources/jquery-ui/jquery-ui.min.css" rel="stylesheet" />
  <script type="text/javascript" src="/resources/js/jquery.min.js"></script>
  <script type="text/javascript" src="/resources/jquery-ui/jquery-ui.min.js"></script>
  <script type="text/javascript" src="/resources/js/jquery.smartmenus.min.js"></script>
  <script type="text/javascript" src="/resources/js/clipboard.min.js"></script>

  <!-- Bootstrap -->
  <script type="text/javascript" src="/resources/bootstrap-5.3.6/js/bootstrap.min.js"></script>

  <!-- ReCaptcha -->
  <script src="https://www.google.com/recaptcha/api.js" type="text/javascript" async="async" defer="defer"></script>
  <!-- Plausible Analytics -->
  <script defer="defer" data-domain="spear.vuexistapps.us" src="https://plausible.io/js/script.js"></script>

  <!-- Add this CSS in the <head> section after your existing stylesheets -->
  <style>
    .container {
      display: flex;
      gap: 2rem;
    }

    .sidebar {
      width: 280px;
      background: #fff;
      padding: 1rem;
      border: 1px solid #ccc;
      max-height: 90vh;
      overflow-y: auto;
    }

    .results {
      flex-grow: 1;
      background: #fff;
      padding: 1rem;
      border: 1px solid #ccc;
      max-height: 190vh;
      overflow-y: auto;
    }

  
    .filter-sidebar {
      background: #f8f9fa;
      border-radius: 0.375rem;
      padding: 1rem;
      margin-top: 1rem;
      border: 1px solid #dee2e6;
    }

    .filter-section {
      margin-bottom: 1.5rem;
    }

    .filter-section:last-child {
      margin-bottom: 0;
    }

    .filter-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
      color: #495057;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 0.5rem;
    }

    .filter-control {
      margin-bottom: 0.5rem;
    }

    .filter-control label {
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
      color: #6c757d;
    }

    .filter-control input[type="text"],
    .filter-control input[type="date"],
    .filter-control select {
      font-size: 0.875rem;
      padding: 0.375rem;
    }

    .filter-control input[type="checkbox"],
    .filter-control input[type="radio"] {
      margin-right: 0.5rem;
    }

    .checkbox-group,
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .checkbox-group label,
    .radio-group label {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0.25rem 0;
    }

    .date-range {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .date-range input {
      flex: 1;
    }

    .uncertainty-slider {
      margin-top: 0.5rem;
    }

    input[type="range"].uncertainty-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: #456889;
      cursor: pointer;
      pointer-events: all;
    }

    .uncertainty-value {
      font-size: 0.75rem;
      color: #6c757d;
      text-align: center;
      margin-top: 0.25rem;
    }

    .filter-actions {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #dee2e6;
      display: flex;
      gap: 0.5rem;
    }
    #personResults, #factoidResults {
  transition: opacity 0.3s ease;
}


    .collapse-toggle {
      background: none;
      border: none;
      padding: 0;
      color: #0d6efd;
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .collapse-toggle:hover {
      text-decoration: underline;
    }

    .filter-content {
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .filter-content.collapsed {
      max-height: 0;
    }

    .filter-content:not(.collapsed) {
      max-height: 500px;
    }

    /* New styles for clear buttons */
    .clear-section-btn {
      background: none;
      border: none;
      color: #dc3545;
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .clear-section-btn:hover {
      text-decoration: underline;
    }

    /* Add these CSS styles to your existing styles */
  .btn-outline-dark {
      background-color: white;
    }

    /* Add these CSS styles for the multiselect dropdown */
    .multiselect-container {
      position: relative;
    }

    .multiselect-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ced4da;
      border-top: none;
      border-radius: 0 0 0.375rem 0.375rem;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .multiselect-dropdown.show {
      display: block;
    }

    .multiselect-option {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid #f8f9fa;
      font-size: 0.875rem;
      transition: background-color 0.15s ease;
    }

    .multiselect-option:hover {
      background-color: #f8f9fa;
    }

    .multiselect-option:last-child {
      border-bottom: none;
    }

    .multiselect-option.selected {
      background-color: #e7f3ff;
      color: #0d6efd;
    }

    .selected-items {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .selected-item {
      background-color: #e7f3ff;
      color: #0d6efd;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      border: 1px solid #b6d7ff;
    }

    .selected-item .remove-btn {
      background: none;
      border: none;
      color: #0d6efd;
      cursor: pointer;
      padding: 0;
      font-size: 0.875rem;
      line-height: 1;
    }

    .selected-item .remove-btn:hover {
      color: #dc3545;
    }

    .relationship-search-input:focus+.multiselect-dropdown {
      display: block;
    }
       .keywordList {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      background: #fafafa;
      padding: 0.5rem;
    }

    .keywordList ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .keywordList li:hover {
      background-color: #eef;
    }

    ul.result-list {
      list-style: none;
      padding-left: 0;
    }

    ul.result-list li {
      margin-bottom: 1rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5rem;
    }

  </style>
</head>

<body id="body">
  <nav class="navbar navbar-expand-lg bg-body-tertiary p-3 justify-content-between align-items-center">
    <div class="container-fluid">
      <a class="navbar-brand banner-container" href="/index.html">
        <span class="syriaca-icon syriaca-syriaca banner-icon"></span>
        <span class="banner-text" data-template="config:app-title">SPEAR<span class="d-none d-md-inline">: Syriac
            Persons Events and Relations</span></span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
        aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <a class="nav-link" aria-current="page" href="/">Home</a>
          <a class="nav-link active" href="/browse.html">Browse</a>
          <a class="nav-link" href="/documentation.html">Documentation</a>
          <a class="nav-link" href="/about.html">About</a>
          <a class="nav-link" href="/contact.html">Contact Us</a>
        </div>
      </div>
    </div>
  </nav>
<div class="container py-4 d-flex align-items-start">

  <div class="d-flex flex-column" style="min-width: 250px">
    <div class="btn-group my-3 sticky-top sticky-offset shadow-lg m-2" role="group" aria-label="types"
              id="browse--types">
              <button type="button" class="btn btn-outline-dark active" data-type="person">
                Persons
              </button>
              <button type="button" class="btn btn-outline-dark" data-type="factoid">
                Factoids
              </button>

            </div>

            <div class="filter-sidebar" id="filter-sidebar">
                <div className="filter-section"><div class="filter-title d-flex justify-content-between align-items-right" style="justify-items: right;">                        <button type="button" class="btn btn-outline-dark" data-type="person" id="clearFiltersBtn">
              Clear selections
            </button></div></div>
            <!-- Source Filter -->
            <div class="filter-section">
              <div class="filter-title d-flex justify-content-between align-items-center">
                Source
                <div class="d-flex gap-2">
                  <button class="clear-section-btn" data-section="source" title="Clear source filter">
                    <span>×</span>
                  </button>
                  <button class="collapse-toggle" data-target="source-select">
                    <span>−</span>
                  </button>
                </div>
              </div>

              <div class="filter-content" id="source-select">
            <div class="checkbox-group" id="sourceSelect">
              <label><input class="me-1" type="checkbox" name="source" value="https://spear-prosop.org/letters-severus" /> Letter of Severus of Antioch</label>
              <label><input class="me-1" type="checkbox" name="source" value="https://spear-prosop.org/lives-eastern-saints" /> Lives of the Eastern Saints</label>
              <label><input class="me-1" type="checkbox" name="source" value="https://spear-prosop.org/chronicle-edessa" /> Chronicle of Edessa</label>
            </div>
          </div>
          </div>
              <!-- Names Filter -->
              <div class="filter-section">
                <div class="filter-title d-flex justify-content-between align-items-center">
                  Names
                  <div class="d-flex gap-2">
                    <button class="clear-section-btn" data-section="names" title="Clear names filter">
                      <span>×</span>
                    </button>
                    <button class="collapse-toggle" data-target="names-filter">
                      <span>−</span>
                    </button>
                  </div>
                </div>
                <div class="filter-content" id="names-filter">
                  <div class="filter-control">
                    <label for="name-search">Search by name:</label>
                    <input type="text" id="name-search" class="form-control form-control-sm"
                      placeholder="Enter name..." />
                  </div>
                                 <!-- Letter Filter -->
                <div id="browse--letter-filter" class="mb-3"></div>
                </div>
  
              </div>
               


              <!-- Gender Filter use checkboxes for multiselection capability -->
    
              <!-- <div class="filter-section">
                <div class="filter-title d-flex justify-content-between align-items-center">
                  Gender
                  <div class="d-flex gap-2">
                    <button class="clear-section-btn" data-section="gender" title="Clear gender filter">
                      <span>×</span>
                    </button>
                    <button class="collapse-toggle" data-target="gender-filter">
                      <span>−</span>
                    </button>
                  </div>
                </div>
                <div class="filter-content" id="gender-filter">
                  <div class="radio-group">
                    <label>
                      <input class="me-1" type="radio" name="gender" value="" checked />
                      All genders
                    </label>
                    <label>
                      <input class="me-1" type="radio" name="gender" value="men" />
                      Men
                    </label>
                    <label>
                      <input class="me-1" type="radio" name="gender" value="women" />
                      Women
                    </label>
                    <label>
                      <input class="me-1" type="radio" name="gender" value="eunuchs" />
                      Eunuchs
                    </label>
                  </div>
                </div>
                              <div class="filter-section">
   
      </div>
              </div> -->
            <div class="filter-section">
              <div class="filter-title d-flex justify-content-between align-items-center">
                Gender
                <div class="d-flex gap-2">
                  <button class="clear-section-btn" data-section="gender" title="Clear gender filter">
                    <span>×</span>
                  </button>
                  <button class="collapse-toggle" data-target="gender-select">
                    <span>−</span>
                  </button>
                </div>
              </div>

              <div class="filter-content" id="gender-select">
            <div class="checkbox-group" id="genderSelect">
              <label><input class="me-1" type="checkbox" name="gender" value="http://syriaca.org/taxonomy/men" /> Men</label>
              <label><input class="me-1" type="checkbox" name="gender" value="http://syriaca.org/taxonomy/women" /> Women</label>
              <label><input class="me-1" type="checkbox" name="gender" value="http://syriaca.org/taxonomy/eunuchs" /> Eunuchs</label>
            </div>
          </div>
          </div>
              <!-- Events Filter -->
              <div class="filter-section">
                     <div class="filter-title d-flex justify-content-between align-items-center">
                  Events
                  <div class="d-flex gap-2">
                    <button class="clear-section-btn" data-section="gender" title="Clear gender filter">
                      <span>×</span>
                    </button>
                    <button class="collapse-toggle" data-target="events-filter">
                      <span>−</span>
                    </button>
                  </div>
                </div>
                                        <div class="filter-content" id="events-filter">
                  <div class="filter-control">
                    <label for="event-multiselect">Select events:</label>
                    <div class="multiselect-container">
                      <input type="text" id="event-search" class="form-control form-control-sm"
                        placeholder="Type to search events..." autocomplete="off" />
                      <div class="multiselect-dropdown" id="event-dropdown">

                      </div>
                      <div class="selected-items" id="event-selected">
                        <!-- Selected items will appear here -->
                      </div>
                    </div>
                  </div>
                
        <div id="eventKeywordList" class="keywordList">
          <ul id="eventKeywordItems"></ul>
        </div>
        </div>
      </div>
 <!-- Relationships Filter -->
      <div class="filter-section">
                     <div class="filter-title d-flex justify-content-between align-items-center">
                  Relationships
                  <div class="d-flex gap-2">
                    <button class="clear-section-btn" data-section="relationships" title="Clear relationships filter">
                      <span>×</span>
                    </button>
                    <button class="collapse-toggle" data-target="relationships-filter">
                      <span>−</span>
                    </button>
                  </div>
                </div>
                        <div class="filter-content" id="relationships-filter">
                  <div class="filter-control">
                    <label for="relationship-multiselect">Select relationships:</label>
                    <div class="multiselect-container">
                      <input type="text" id="relationship-search" class="form-control form-control-sm"
                        placeholder="Type to search relationships..." autocomplete="off" />
                      <div class="multiselect-dropdown" id="relationship-dropdown">
     
                      </div>
                      <div class="selected-items" id="relationship-selected">
                        <!-- Selected items will appear here -->
                      </div>
                    </div>
                  </div>
                
        <div id="relationshipKeywordList" class="keywordList">
          <ul id="relationshipKeywordItems" class="keywordItems"></ul>
        </div></div>
      
      </div>
<!-- Ethnicity Filter -->
      <div class="filter-section">
        Ethnicity
        <div id="ethnicityKeywordList" class="keywordList">
            <ul id="ethnicityKeywordItems"></ul>
        </div>
      </div>
        <div class="filter-section">
                <div class="filter-title d-flex justify-content-between align-items-center">
                  Place
                  <div class="d-flex gap-2">
                    <button class="clear-section-btn" data-section="place" title="Clear place filter">
                      <span>×</span>
                    </button>
                    <button class="collapse-toggle" data-target="place-filter">
                      <span>−</span>
                    </button>
                  </div>
                </div>
        
                <div class="filter-content" id="place-filter">
                  <div class="filter-control">
                    <label for="place-multiselect">Select place:</label>
                    <div class="multiselect-container">
                      <input type="text" id="place-search" class="form-control form-control-sm"
                        placeholder="Type to search places..." autocomplete="off" />
                      <div class="multiselect-dropdown" id="place-dropdown">
                      </div>
                      <div class="selected-items" id="place-selected">
                        <!-- Selected items will appear here -->
                      </div>
                    </div>
                  </div>
                  <div id="placeKeywordList" class="keywordList">
                    <ul id="placeKeywordItems"></ul>
                  </div>
                </div>
        </div>


              <!-- Uncertainty Filter -->
              <div class="filter-section">
                <div class="filter-title d-flex justify-content-between align-items-center">
                  Uncertainty
                  <div class="d-flex gap-2">
                    <button class="clear-section-btn" data-section="uncertainty" title="Clear uncertainty filter">
                      <span>×</span>
                    </button>
                    <button class="collapse-toggle" data-target="uncertainty-filter">
                      <span>−</span>
                    </button>
                  </div>
                </div>
                <div class="filter-content" id="uncertainty-filter">
                  <div class="filter-control">
   <div class="checkbox-group" id="uncertaintySelect">
    <label>Exclude by uncertainty level:</label>
    <label><input class="me-1" type="checkbox" name="uncertainty" value="errata" /> Errata</label>
    <label><input class="me-1" type="checkbox" name="uncertainty" value="dubia" /> Dubia</label>
    <label><input class="me-1" type="checkbox" name="uncertainty" value="incerta" /> Incerta</label>
  </div>
                  </div>
                </div>
              </div>
              <div class="filter-content" id="uncertainty-filter">
  
 
</div>
            </div>
  </div>
          <!-- <div class="flex-grow-1">
            <div class="card ms-5 p-3 flex-grow-1 shadow-lg border-0">
 
              <hr class="d-none" />
              <div id="browse--items" class="grid-col-5 gap-3"></div>
              <div class="pagination-dots d-none"></div>
            </div>
            <div class="ms-5 mt-3 p-3" id="browse--items-container"></div>
          </div> -->
<div class="new-results">
  <!-- Persons results  -->
<div id="personResultsog">
    <div class="card p-3 shadow-lg border-0">
      <hr class="d-none" />
      <div id="browse--items" class="grid-col-5 gap-3"></div>
      <div class="pagination-dots d-none"></div>
    </div>
    <div class="mt-3 p-3" id="browse--items-container"></div>
  </div>


  <!-- Factoid results -->
<div id="factoidResults" class="d-none">
  <div class="card p-3 shadow-lg border-0">
    <div id="factoid-items" class="grid-col-5 gap-3"></div>
    <div class="pagination-dots" id="factoid-pagination"></div>
  </div>
</div>
<div id="defaultFactoidResults" class="d-none">
  <div class="card p-3 shadow-lg border-0">
    <div id="default-factoid-items" class="grid-col-5 gap-3"></div>
    <div class="pagination-dots" id="default-factoid-pagination"></div>
  </div>
</div>
</div>
        </div>
      </div>
    </div>
  </div>
</body>
<script type="text/javascript" src="/resources/js/jquery.validate.min.js"></script>
<script type="text/javascript" src="/resources/js/srophe.js"></script>
<script type="module">
  // Constants
  const ITEMS_PER_PAGE = 15;
  const SPARQL_ENDPOINT = "https://sparql.vanderbilt.edu/sparql";
 
  // State
  let currentPage = 1;
  let totalPages = 1;
  let allItems = [];

  // Imports
  import { initializeFilter } from './filter.js';
  import persons from "./types/persons.json" with { type: 'json' };
  import personNamesData from "./types/factoid/names.json" with { type: 'json' };
  import factoids from "./types/factoids.json" with { type: 'json' };
  
  // Data
  let people = persons.results?.bindings;
  let personNames = personNamesData.results?.bindings;
  console.log("Person Names Data:", personNames);
  // DOM Elements (cached)
  const elements = {
    browseOptions: document.getElementById("browse--options"),
    browseTypes: document.getElementById("browse--types"),
    browseItems: document.getElementById("browse--items"),
    browseLetterFilter: document.getElementById("browse--letter-filter"),
    paginationDots: document.querySelector('.pagination-dots'),
    sidebar: document.getElementById('filter-sidebar'),
    nameSearch: document.getElementById('name-search'),
  };

  // Utility Functions
  const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  };

  const getUrlParams = () => Object.fromEntries(new URLSearchParams(window.location.search));

  const updateUrlParams = (params) => {
    const currentParams = new URLSearchParams(window.location.search);
    Object.entries(params).forEach(([key, value]) => {
      if (value) currentParams.set(key, value);
      else currentParams.delete(key);
    });
    window.history.pushState("", "", `?${currentParams.toString()}`);
  };

  // Data Fetching
  const fetchData = async (query) => {
    const encodedQuery = encodeURIComponent(query);
    const res = await fetch(`${SPARQL_ENDPOINT}?query=${encodedQuery}`, {
      headers: { Accept: 'application/sparql-results+json' }
    });
    return res.json();
  };
  
//Can switch to using setupKeywordList if needed


  // UI State Management
  const setActiveButton = (container, selector, activeValue) => {
    container?.querySelectorAll("button").forEach(button => {
      const dataValue = button.dataset[selector];
      button.classList.toggle("active", dataValue === activeValue);
    });
  };

  const clearDisplay = () => {
    elements.browseItems.innerHTML = '';
    const hrElement = elements.browseItems.previousElementSibling;
    if (hrElement) hrElement.classList.add('d-none');
    elements.paginationDots.classList.add('d-none');
  };

  // Pagination
  const createPaginationDots = (totalItems) => {
    if (!elements.browseItems) return;

    const existingPagination = elements.browseItems.parentNode.querySelector('.pagination-dots');
    if (existingPagination) existingPagination.innerHTML = '';

    if (totalItems <= ITEMS_PER_PAGE) {
      totalPages = 1;
      currentPage = 1;
      elements.paginationDots.classList.add('d-none');
      return;
    }

    elements.paginationDots.classList.remove('d-none');
    totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

    for (let i = 1; i <= totalPages; i++) {
      const dot = document.createElement('button');
      dot.className = `pagination-dot ${i === currentPage ? 'active' : ''}`;
      dot.setAttribute('data-page', i);
      dot.setAttribute('aria-label', `Go to page ${i}`);
      elements.paginationDots.appendChild(dot);
    }
  };

  const displayPageItems = (items) => {
    if (!elements.browseItems) return;

    elements.browseItems.innerHTML = '';
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    const pageItems = items.slice(startIndex, endIndex);

    elements.browseItems.innerHTML = pageItems
      .map(item => `<button data-name="${item}" class="btn btn-outline p-2 px-3">${item}</button>`)
      .join("");

    elements.browseItems.previousElementSibling.classList.remove('d-none');
  };

  const goToPage = (page) => {
    if (page < 1 || page > totalPages) return;

    currentPage = page;

    document.querySelectorAll('.pagination-dot').forEach((dot, index) => {
      dot.classList.toggle('active', index + 1 === currentPage);
    });

    updateParams({ currentPage: page });
  };

  // Main update functions
  const updateParams = (params) => {
  // Get current URL params
  const trigger = Object.keys(params)[0];
  let currentParams = new URLSearchParams(window.location.search);
  // Apply side-effects (reset buttons, inputs, etc.)
  const paramActions = {
    letter: () => {
      currentParams.delete("person");
      currentParams.delete("nameSearch");
      if (!currentParams.get("relationship")) currentParams.set("currentPage", 1);
      if (elements.browseLetterFilter) {
        elements.browseLetterFilter.querySelectorAll("button").forEach(b => b.classList.remove("active"));
      }
      if (elements.nameSearch) elements.nameSearch.value = '';
    },
    filter: () => {
      ["person", "letter", "gender", "nameSearch"].forEach(p => currentParams.delete(p));
      if (elements.browseLetterFilter) {
        elements.browseLetterFilter.querySelectorAll("button").forEach(b => b.classList.remove("active"));
      }
      if (elements.nameSearch) elements.nameSearch.value = '';
    },
    type: () => {
      ["person", "letter", "gender", "nameSearch"].forEach(p => currentParams.delete(p));
      if (elements.browseLetterFilter) {
        elements.browseLetterFilter.querySelectorAll("button").forEach(b => b.classList.remove("active"));
      }
      if (elements.nameSearch) elements.nameSearch.value = '';
    },
    nameSearch: () => {
      ["letter", "gender"].forEach(p => currentParams.delete(p));
      if (elements.browseLetterFilter) {
        elements.browseLetterFilter.querySelectorAll("button").forEach(b => b.classList.remove("active"));
      }
    },
    gender: () => {
      ["nameSearch", "letter"].forEach(p => currentParams.delete(p));
      if (elements.nameSearch) elements.nameSearch.value = '';
      if (elements.browseLetterFilter) {
        elements.browseLetterFilter.querySelectorAll("button").forEach(b => b.classList.remove("active"));
      }
    }
  };

  // Run param-based actions (optional UI cleanup)
  paramActions[trigger]?.();

  // Build the new param set
  const newParams = new URLSearchParams(currentParams.toString());
  for (const [key, value] of Object.entries(params)) {
    newParams.set(key, value);
  }

  // Compare old and new
  if (newParams.toString() !== currentParams.toString()) {
    window.history.pushState({}, '', `?${newParams.toString()}`);
    handleDataUpdate(Object.fromEntries(newParams));
  }
};


const handleDataUpdate = (params, event) => {
  if (params.person) {
    updateData(params);
    return;
  }

  if (params.nameSearch) {
    elements.nameSearch.value = params.nameSearch;
    applyNameFilter(params.nameSearch);
    return;
  }

  if ((params.letter || params.gender || params.filter || params.type) && !params.nameSearch) {
    if (elements.nameSearch) elements.nameSearch.value = '';
  }

  updateData(params, event);
};



  // Multiselect functionality
  class MultiselectDropdown {
    constructor(containerId, options, onSelectionChange) {
      this.container = document.getElementById(containerId);
      this.searchInput = this.container.querySelector('#relationship-search');
      this.dropdown = this.container.querySelector('#relationship-dropdown');
      this.selectedContainer = this.container.querySelector('#relationship-selected');
      this.options = options;
      this.selectedValues = new Set();
      this.onSelectionChange = onSelectionChange;

      this.init();
    }

    init() {
      this.renderOptions();
      this.bindEvents();
    }

    renderOptions(filter = '') {
      const filteredOptions = this.options.filter(option =>
        option.label.toLowerCase().includes(filter.toLowerCase())
      );

      this.dropdown.innerHTML = filteredOptions
        .map(option => `
            <div class="multiselect-option ${this.selectedValues.has(option.value) ? 'selected' : ''}"
                 data-value="${option.value}">
              ${option.label}
            </div>
          `).join('');
    }

    bindEvents() {
      // Search input events
      this.searchInput.addEventListener('input', (e) => {
        const filter = e.target.value;
        this.renderOptions(filter);
        this.showDropdown();
      });

      this.searchInput.addEventListener('focus', () => {
        this.showDropdown();
      });

      // Dropdown option clicks
      this.dropdown.addEventListener('click', (e) => {
        if (e.target.classList.contains('multiselect-option')) {
          const value = e.target.dataset.value;
          this.toggleSelection(value);
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!this.container.contains(e.target)) {
          this.hideDropdown();
        }
      });

      // Keyboard navigation
      this.searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          this.hideDropdown();
        }
      });
    }

    toggleSelection(value) {
      if (this.selectedValues.has(value)) {
        this.selectedValues.delete(value);
      } else {
        this.selectedValues.add(value);
      }

      this.renderSelectedItems();
      this.renderOptions(this.searchInput.value);
      this.onSelectionChange(Array.from(this.selectedValues));
    }

    renderSelectedItems() {
      const selectedOptions = this.options.filter(option =>
        this.selectedValues.has(option.value)
      );

      this.selectedContainer.innerHTML = selectedOptions
        .map(option => `
            <div class="selected-item" data-value="${option.value}">
              ${option.label}
              <button type="button" class="remove-btn" data-value="${option.value}">×</button>
            </div>
          `).join('');

      // Bind remove button events
      this.selectedContainer.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const value = e.target.dataset.value;
          this.toggleSelection(value);
        });
      });
    }

    showDropdown() {
      this.dropdown.classList.add('show');
    }

    hideDropdown() {
      this.dropdown.classList.remove('show');
    }

    clear() {
      this.selectedValues.clear();
      this.renderSelectedItems();
      this.renderOptions();
      this.searchInput.value = '';
      this.onSelectionChange([]);
    }

    setSelection(values) {
      this.selectedValues = new Set(values);
      this.renderSelectedItems();
      this.renderOptions();
    }
  } 

  // Update the filter configurations
  const filterConfigs = {
    names: {
      controls: ['name-search'],
      urlParams: ['nameSearch', 'nameType'],
      onClear: () => {
        if (elements.nameSearch) {
          elements.nameSearch.value = '';
          handleNameSearch();
        }
      }
    },
    gender: {
      controls: ['input[name="gender"][value=""]'],
      urlParams: ['gender'],
      onClear: () => {
        const allGendersRadio = document.querySelector('input[name="gender"][value=""]');
        if (allGendersRadio) {
          allGendersRadio.checked = true;
          allGendersRadio.dispatchEvent(new Event('change'));
        }
      }
    },
    events: {
      controls: ['event-type', '#events-filter input[type="checkbox"]'],
      urlParams: ['events', 'eventType'],
      onClear: () => {
        const eventTypeSelect = document.getElementById('event-type');
        if (eventTypeSelect) eventTypeSelect.value = '';
        document.querySelectorAll('#events-filter input[type="checkbox"]').forEach(cb => cb.checked = false);
      }
    },
    relationships: {
      controls: ['relationship-multiselect'],
      urlParams: ['relationships'],
      onClear: () => {
        if (window.relationshipMultiselect) {
          window.relationshipMultiselect.clear();
        }
      }
    }
  };

  const clearFilterSection = (sectionName) => {
    console.log(`Clearing ${sectionName} filter...`);

    const config = filterConfigs[sectionName];
    if (!config) return;

    // Execute section-specific clear logic
    config.onClear();

    // Remove URL parameters
    const params = new URLSearchParams(window.location.search);
    config.urlParams.forEach(param => params.delete(param));
    window.history.pushState("", "", `?${params.toString()}`);

    console.log(`${sectionName} filter cleared successfully`);
  };

  // Search and Filter Logic!!!!
  const applyNameFilter = (searchTerm) => {
    const currentParams = getUrlParams();
    const currentFilter = currentParams.filter || 'name';
    const currentType = currentParams.type || 'person';
    
    let filteredItems = [];

    if ((currentFilter === 'name' || currentParams.nameSearch)) {
      // This shows person name options
      filteredItems = personNames
        .filter(person => person.name.value.toLowerCase().includes(searchTerm.toLowerCase()))
        .map(person => person.name.value);
    } 
    
    if (currentParams.person && currentType === 'factoid') {
      filteredItems = personNames
        .filter(item => item.name.value.toLowerCase().includes(searchTerm.toLowerCase()))
        .map(item => item.name.value);
    }

    // Remove duplicates
    filteredItems = [...new Set(filteredItems)];

    allItems = filteredItems;
    currentPage = 1;

    createPaginationDots(filteredItems.length);
    displayPageItems(filteredItems);

    elements.browseItems.previousElementSibling.classList.remove('d-none');
    updateParams({ nameSearch: searchTerm, currentPage: 1 });
  };

  const handleNameSearch = () => {
    const nameSearchValue = elements.nameSearch?.value.trim();

    if (nameSearchValue) {
      applyNameFilter(nameSearchValue);
    } else {
      const currentParams = getUrlParams();
      if (currentParams.letter || currentParams.gender) {
        updateData(currentParams);
      } else {
        clearDisplay();
      }
    }
  };

  const handleGenderFilter = (event) => {
    const selectedGender = event.target.value;

    if (selectedGender) {
      updateParams({ gender: selectedGender });
    } else {
      const currentParams = new URLSearchParams(window.location.search);
      currentParams.delete('gender');
      window.history.pushState("", "", `?${currentParams.toString()}`);
      updateData(Object.fromEntries(currentParams));
    }
  };

 const updateData = (params) => {
  document.getElementById('defaultFactoidResults').innerHTML = '';
  document.getElementById('factoidResults').innerHTML = '';
  clearDisplay();
  const type = params.type || 'person';
  const dataset = type === 'factoid' ? personNames : people;
  console.log("PARAMS IN UPDATE DATA:", params);

  let filteredItems = []; 

  // 1. Filter by letter
  if (params.letter) {
    filteredItems = dataset
      .filter(person => person.name?.value?.toLowerCase().startsWith(params.letter.toLowerCase()))
      .map(person => person.name.value);
  }

  // 2. Filter by gender
  if (params.gender) {
    filteredItems = dataset
      .filter(person => person.sex?.value?.toLowerCase() === params.gender.toLowerCase())
      .map(person => person.name.value);
  }

  // 3. Filter by both letter + gender
  if (params.letter && params.gender) {
    filteredItems = dataset
      .filter(person =>
        person.name?.value?.toLowerCase().startsWith(params.letter.toLowerCase()) &&
        person.sex?.value?.toLowerCase() === params.gender.toLowerCase()
      )
      .map(person => person.name.value);
  }



  // 5. Remove duplicates, paginate and render
  allItems = [...new Set(filteredItems)];
  currentPage = 1;
  createPaginationDots(allItems.length);
  displayPageItems(allItems);

  // Show the result section
  elements.browseItems.previousElementSibling?.classList.remove('d-none');

  // 6. Handle direct person selection (e.g., after clicking a name button)
if (params.person) {
  console.log("Direct person selection:", params.person);
  const personMatch = dataset.filter(p => p.name.value === params.person);
console.log("Person match:", personMatch);
  if (personMatch.length > 0) {
    const cardsHtml = personMatch.map(person => {
      // Match the correct field for description and URL
      const desc = person.desc?.value || person.description?.value || '';
      const uri = person.uri?.value || person.factoid?.value || '';
      let href = '#';

      if (uri.includes('/')) {
        // Build correct link based on source format
        const captured = uri.match(/\/(?<id>(\d+)-(\d+))$/) || uri.match(/\/(?<cat>\w+)\/(?<id>\d+)$/);
        if (captured?.groups) {
          const path = Object.values(captured.groups).join('/');
          href = (type === 'factoid') ? `/${path}` : `/aggregate/${path}`;
        }
      }

      return `
        <div class="card mb-3 p-3">
          <div class="card-body">
            <a href="${href}" class="cursor-pointer py-3 border-2 border-transparent rounded-sm">${person.name.value}</a>
            <small>${desc}</small>
          </div>
        </div>
      `;
    }).join('');

    document.getElementById("browse--items-container").innerHTML = cardsHtml;

    // Scroll to results
    document.getElementById("browse--items-container").scrollIntoView({
      behavior: "smooth",
      block: "start",
      inline: "start"
    });
  } else {
    document.getElementById("browse--items-container").innerHTML = `<p>No data found for ${params.person}</p>`;
  }

  return;
}
elements.browseItems.querySelectorAll("button").forEach(button => {
  button.classList.toggle("active", button.dataset.name === params.person);
});


};

  
  // Event Handlers
    const createEventHandler = (container, handler) => {
    container?.addEventListener("click", (event) => {
        const target = event.target.closest("button");
        if (!target) return;
        event.preventDefault(); // only if it's a real button
        handler(event);
    });
    };

  // Initialize Event Listeners
  const initEventListeners = () => {
    // Pagination
    elements.paginationDots?.addEventListener("click", (event) => {
      event.preventDefault();
      if (event.target.classList.contains('pagination-dot')) {
        const selectedPage = parseInt(event.target.dataset.page);
        if (!isNaN(selectedPage)) goToPage(selectedPage);
      }
    });

    // Filter sidebar
    elements.sidebar?.addEventListener('click', (event) => {
      // Collapse/expand
    const collapseBtn = event.target.closest('.collapse-toggle');
    if (collapseBtn) {
      const targetId = collapseBtn.dataset.target;
      const targetElement = document.getElementById(targetId);

      if (targetElement) {
        targetElement.classList.toggle('collapsed');
        collapseBtn.querySelector('span').textContent =
          targetElement.classList.contains('collapsed') ? '+' : '−';
      }
    }


      // Clear buttons
      if (event.target.classList.contains('clear-section-btn') ||
        event.target.parentElement.classList.contains('clear-section-btn') ||
        (event.target.tagName === 'SPAN' && event.target.parentElement.classList.contains('clear-section-btn'))) {

        let clearButton = event.target;
        if (event.target.tagName === 'SPAN') {
          clearButton = event.target.parentElement;
        } else if (event.target.parentElement.classList.contains('clear-section-btn')) {
          clearButton = event.target.parentElement;
        }

        const sectionName = clearButton.dataset.section;
        if (sectionName) {
          event.preventDefault();
          event.stopPropagation();
          clearFilterSection(sectionName);
        }
      }
    });



    // Name search
    elements.nameSearch?.addEventListener('input', debounce(handleNameSearch, 300));

    // Gender filter
    document.querySelectorAll('input[name="gender"]').forEach(radio => {
      radio.addEventListener('change', handleGenderFilter);
    });

    // Main browse event handlers
    createEventHandler(elements.browseLetterFilter, (event) => {
      if (event.target.tagName === "BUTTON") {
        document.getElementById("browse--items-container").innerHTML = null;
        const selectedButton = event.target;
        console.log('Browse type clicked:', selectedButton.dataset.type);

        if(elements.browseLetterFilter) {
          elements.browseLetterFilter.querySelectorAll("button").forEach(button => {
            button.classList.remove("active");
          });
        }
 
        selectedButton.classList.add("active");

        if (selectedButton.dataset.letter) updateParams({ letter: selectedButton.dataset.letter });
        if (selectedButton.dataset.gender) updateParams({ gender: selectedButton.dataset.gender });
        if (selectedButton.dataset.events) updateParams({ events: selectedButton.dataset.events });
      }
    });

    createEventHandler(elements.browseOptions, (event) => {
      const selectedButton = event.target.tagName === "BUTTON" ? event.target : event.target.parentElement;
      if (selectedButton.tagName !== "BUTTON") return;

      elements.browseLetterFilter.innerHTML = null;
      elements.browseItems.innerHTML = null;

      elements.browseOptions.querySelectorAll("button").forEach(button => {
        button.classList.remove("active");
      });
      selectedButton.classList.toggle("active");

      document.getElementById("browse--items-container").innerHTML = null;
      updateParams({ filter: selectedButton.dataset.filter });
    });

    createEventHandler(elements.browseItems, (event) => {
      if (event.target.tagName === "BUTTON") {
        const selectedButton = event.target;
        elements.browseItems.querySelectorAll("button").forEach(button => {
          button.classList.remove("active");
        });
        selectedButton.classList.add("active");
        const selectedName = selectedButton.dataset.name;
        const current = new URLSearchParams(window.location.search).get("person");
        if (current?.toLowerCase() !== selectedName.toLowerCase()) {
          updateParams({ person: selectedName });
        }
      }
    });

    createEventHandler(elements.browseTypes, (event) => {
      if (event.target.tagName === "BUTTON") {
        const selectedButton = event.target;
        elements.browseTypes.querySelectorAll("button").forEach(button => {
          button.classList.remove("active");
        });
        selectedButton.classList.add("active");
        updateParams({ type: selectedButton.dataset.type });
        // Toggle views after click
    const personResults = document.getElementById('personResults');
    const factoidResults = document.getElementById('factoidResults');

    if (selectedButton.dataset.type === 'factoid') {
    personResults?.classList.add('d-none');
    factoidResults?.classList.remove('d-none');
    } else {
    personResults?.classList.remove('d-none');
    factoidResults?.classList.add('d-none');
    }
    createAlphabetMenu();

      }
    });

    // Initialize relationship multiselect
  };

  // Function to initialize relationships from URL parameters
  const initRelationshipsFromUrl = () => {
    const params = getUrlParams();
    if (params.relationships && window.relationshipMultiselect) {
      const selectedValues = params.relationships.split(',');
      window.relationshipMultiselect.setSelection(selectedValues);
    }
  };
  function createAlphabetMenu() {
  const container = elements.browseLetterFilter;
  if (!container) return;

  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

  container.innerHTML = alphabet
    .map(letter => `<button type="button" class="btn btn-sm btn-outline-secondary" data-letter="${letter}">${letter}</button>`)
    .join("");
}


  // Update the init function to include relationship initialization
  const init = () => {
    const params = getUrlParams();
    createAlphabetMenu();

    // Set initial states
    setActiveButton(elements.browseTypes, 'type', params.type || 'person');
    // Toggle results panels


    setActiveButton(elements.browseOptions, 'filter', params.filter || 'name');
    setActiveButton(elements.browseLetterFilter, 'letter', params.letter);
    console.log("Params in init:", params);
    // Set name search from URL
    if (params.nameSearch && elements.nameSearch) {
      elements.nameSearch.value = params.nameSearch;
    }

    // Initialize relationships from URL
    setTimeout(() => {
      initRelationshipsFromUrl();
    }, 100); // Small delay to ensure multiselect is initialized

    handleDataUpdate(params);
  };
  document.addEventListener('DOMContentLoaded', () => {
    init();
    initEventListeners();
  });

    document.addEventListener('DOMContentLoaded', initializeFilter);
window.addEventListener("popstate", () => {
  const params = getUrlParams();
  handleDataUpdate(params);
});


</script>


</html>
